<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="main.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">


  </head>
  <body>

    <div>
      <div class="header">
        <div class="nav">
          <h1 id="use"> name:</h1>
          <button id="remove" onclick="myFun()">logout</button>
        </div>

      </div>
    </div>

    <div class="task-com-un-all">
      <button type="button" id="all">all</button>
      <button type="button" id="complete">completed</button>
      <button type="button" id="uncomplete">uncompleted</button>
    </div>


    <div class="container">
      <div class="app">
        <h1>TODO LIST</h1>
        <form>
          <input style="border-radius:0px; border: 1px solid #84c084; height:
            100%; outline: #27d427;" type="text" placeholder="Add task"
            class="description">
          <button type="button" class="add_description">&plus;</button>
          <input type="button" class="clear" value="clear all" style="width:
            10%; cursor: pointer;" onclick="clearTodo(this)">

          <!-- <select class="select-type">
            <option id="select-all" value="all">All</option>
            <option id="select_completed" value="completed">Complete</option>
            <option id="select-UnCompleted" value="UnCompleted">UnCompleted</option>
          </select> -->
        </form>


        <ul id="rem"></ul>
      </div>
    </div>

    <script type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <!-- <h1 id="activeUserF"></h1><span id="activeUserL"></span> -->


    <script>
         document.querySelector('#use').innerHTML=JSON.parse(localStorage.getItem("activeUser")).FirstName ;

         function myFun(){
             localStorage.removeItem("activeUser");
            //  document.querySelector('#activeUser').innerHTML="da";
             window.location.href='login.html';
         }

         document.querySelector('.add_description').addEventListener('click',function(){

         let todo_des = document.querySelector('.description').value;
   
         let activeUser = JSON.parse(localStorage.getItem("activeUser"));
         activeUser.todos.push({
              description:todo_des,
               completed: false,
            });

            localStorage.setItem("activeUser", JSON.stringify(activeUser));
               let users = JSON.parse(localStorage.getItem("users"));

            // users.filter((item) => {
            //   if(activeUser.email === item.email){
            //     // users.push(activeUser)
                
            //     // users.todos=todo_des;
            //   }
            // })
            //   console.log(users);

            // users.map(obj => obj.activeUser || obj);
            // //  let activeUserobj= users.find((u) => u.email === eemail.value);
            // //  console.log(users)


             users.forEach((element) => {
              //  debugger;
                if(element.email === activeUser.email) {
                  //  console.log(users[index],'test',element.email === activeUser.email)
                    element.todos.push({
                        description:todo_des,
                        completed: false,
                      });
                }
            });
          
           localStorage.setItem("users", JSON.stringify(users));
           addTask();
           document.querySelector("form").reset();
         });
       
    window.onload = loadTasks;
    function loadTasks() {
   
      let activeUser = JSON.parse(localStorage.getItem("activeUser"));
      let todos_item = activeUser.todos;
    
 
      todos_item.forEach((task , index) => {
        const list = document.querySelector("ul");
        const li = document.createElement("li");
        li.innerHTML = `<input type="checkbox" class="check" onclick="taskComplete(this)" ${task.completed ? 'checked' : ''}>
        
          <input type="text" value="${task.description}" class="edited ${task.completed ? 'completed' : ''}" onfocus="getCurrentTask(this)" >
           <ion-icon name="create-outline" class="edit" onclick ="editTask(this)"></ion-icon>
         <ion-icon class="del" name="trash-outline" onclick="removeTask(this)"></ion-icon>`;
         
        list.insertBefore(li, list.children[0]);
      });
    }
    function addTask(){
      
  let des = document.querySelector(".description").value
 
        const list = document.querySelector("ul");
        const li = document.createElement("li");
        li.innerHTML = `<input type="checkbox" class="check" onclick="taskComplete(this)" >
          <input type="text" value=${JSON.stringify(des)} class="edited" onfocus="getCurrentTask(this)" >
          <ion-icon name="create-outline" class="edit" onclick ="editTask(this)"></ion-icon>
         <ion-icon class="del" name="trash-outline"  onclick="removeTask(this)"></ion-icon>`;
        //  debugger;
        list.insertBefore(li, list.children[0]);
    }

     let currentTask = null;

    // get current task
    function getCurrentTask(event) {
      currentTask = event.value; 
    }
  function editTask(event){


    let edit_des = event.previousElementSibling.value;
 
    let activeUser = JSON.parse(localStorage.getItem("activeUser"));
    let todos_item = activeUser.todos;

    todos_item.forEach(task => {
      if (task.description === currentTask) {
        task.description = edit_des;
        }
        });
      
        localStorage.setItem("activeUser", JSON.stringify(activeUser));

        let users = JSON.parse(localStorage.getItem("users"));
// for users edit description
        users.forEach((element) => {

          if(element.email === activeUser.email) {
            let items = element.todos;
       
            items.forEach(task => {
              if (task.description === currentTask) {
                task.description = edit_des;
              
              }
            });
            localStorage.setItem("users", JSON.stringify(users));
            alert("description is edited ");
          }
        });
      }

function removeTask(event) {

    let activeUser = JSON.parse(localStorage.getItem("activeUser"));
      let todos_item = activeUser.todos;
 
      todos_item.forEach(task => {
        if (task.description === event.parentNode.children[1].value) {
          // delete task
          todos_item.splice(todos_item.indexOf(task), 1);
      
          localStorage.setItem("activeUser", JSON.stringify(activeUser));
        }

      });
      //  localStorage.setItem("users", JSON.stringify(users));
      

      
  let users = JSON.parse(localStorage.getItem("users"));
      // let todos_items = users.todos;

users.forEach((element) => {
              //  debugger;
                if(element.email === activeUser.email) {
                  let items = element.todos;
                  items.forEach(task => {
        if (task.description === event.parentNode.children[1].value) {
          // delete task
          items.splice(todos_item.indexOf(task), 1);
         

          localStorage.setItem("users", JSON.stringify(users));
        }

      });
                }
            });
            event.parentElement.remove();
          
    }
     function taskComplete(event) {
      let activeUser = JSON.parse(localStorage.getItem("activeUser"));
      let task_cmp=activeUser.todos;
  
      task_cmp.forEach(task => {
        if (task.description === event.nextElementSibling.value) {
          task.completed = !task.completed;
        }
      });
      localStorage.setItem("activeUser", JSON.stringify(activeUser));


let users = JSON.parse(localStorage.getItem("users"));
users.forEach((element) => {
// debugger;
if (element.email === activeUser.email) {
let items = element.todos;
items.forEach((task) => {
if (task.description === event.nextElementSibling.value) {
task.completed = !task.completed;
}
});
}
});

localStorage.setItem("users", JSON.stringify(users));
      event.nextElementSibling.classList.toggle("completed");
    }

    function clearTodo(event){
       let activeUser = JSON.parse(localStorage.getItem("activeUser"));
     
      let todos_item = activeUser.todos;
      todos_item.length=0;
      localStorage.setItem("activeUser", JSON.stringify(activeUser));

      

      let myList = document.getElementById('rem')
      myList.remove();
      
      // myList.innerHTML = '';
    }

    let all = document.querySelector('#all');
    let complete = document.querySelector('#complete');
    let uncomplete = document.querySelector('#uncomplete');
    
    let ul_node = document.getElementById("rem");

   
    function allComUn(){
            while (ul_node.firstChild) {
      ul_node.removeChild(ul_node.firstChild);    
}
loadTasks();
    }




    function completed(){
      while (ul_node.firstChild) {
      ul_node.removeChild(ul_node.firstChild);    
}
     
      let activeUser = JSON.parse(localStorage.getItem("activeUser"));
      let todos_item = activeUser.todos;

      todos_item.forEach(task => {

         let list = document.querySelector("ul");
        let li = document.createElement("li");
        if (task.completed === true) {  
        li.innerHTML = `<input type="checkbox" class="check" onclick="taskComplete(this)" ${task.completed ? 'checked' : ''}>
        
          <input type="text" value="${task.description}" class="edited ${task.completed ? 'completed' : ''}" onfocus="getCurrentTask(this)" >
           <ion-icon name="create-outline" class="edit" onclick ="editTask(this)"></ion-icon>
         <ion-icon class="del" name="trash-outline" onclick="removeTask(this)"></ion-icon>`;
         
        list.insertBefore(li, list.children[0]);
        }
      });

    }


      function unCompleted(){
      while (ul_node.firstChild) {
      ul_node.removeChild(ul_node.firstChild);    
}
     
      let activeUser = JSON.parse(localStorage.getItem("activeUser"));
      let todos_item = activeUser.todos;

      todos_item.forEach(task => {

         let list = document.querySelector("ul");
        let li = document.createElement("li");
        if (!task.completed === true) {  
        li.innerHTML = `<input type="checkbox" class="check" onclick="taskComplete(this)" ${task.completed ? 'checked' : ''}>
        
          <input type="text" value="${task.description}" class="edited ${task.completed ? 'completed' : ''}" onfocus="getCurrentTask(this)" >
           <ion-icon name="create-outline" class="edit" onclick ="editTask(this)"></ion-icon>
         <ion-icon class="del" name="trash-outline" onclick="removeTask(this)"></ion-icon>`;
         
        list.insertBefore(li, list.children[0]);
        }
      });

    }

    complete?.addEventListener("click",completed);
    uncomplete?.addEventListener("click",unCompleted);
    all?.addEventListener("click",allComUn);

    //  function loadTasks() {
   
    //   let activeUser = JSON.parse(localStorage.getItem("activeUser"));
    //   let todos_item = activeUser.todos;
    
 
    //   todos_item.forEach((task , index) => {
    //     const list = document.querySelector("ul");
    //     const li = document.createElement("li");
    //     li.innerHTML = `<input type="checkbox" class="check" onclick="taskComplete(this)" ${task.completed ? 'checked' : ''}>
        
    //       <input type="text" value="${task.description}" class="edited ${task.completed ? 'completed' : ''}" onfocus="getCurrentTask(this)" >
    //        <ion-icon name="create-outline" class="edit" onclick ="editTask(this)"></ion-icon>
    //      <ion-icon class="del" name="trash-outline" onclick="removeTask(this)"></ion-icon>`;
         
    //     list.insertBefore(li, list.children[0]);
    //   });
    // }
    // sc.addEventListener('click',function(){


    // });
    
         </script>
  </body>
</html>